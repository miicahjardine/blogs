{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "POC": {
            "type": "string",
            "maxLength": 4,
            "metadata": {
                "description": "The name of the POC or Proof of Concept"
            }
        },
        "location": {
            "type": "string",
            "allowedValues": [
                "UKWest",
                "UKSouth"
            ],
            "metadata": {
                "description": "Location that the resources will be deployed to"
            }
        },
        "environment": {
            "type": "string",
            "allowedValues": [
                "Prod",
                "DEV",
                "TST",
                "PPE"
            ],
            "metadata": {
                "description": "Environment name"
            }
        },
        "owner": {
            "type": "string",
            "metadata": {
                "description": "The owner / developer of the resource"
            }
        },
        "ssName": {
            "type": "string",
            "metadata": {
                "description": "The name for the scale set"
            }
        },
        "vmName": {
            "type": "string",
            "metadata": {
                "description": "The name for the virtual machine"
            }
        },
        "adminUserName": {
            "type": "string",
            "metadata": {
                "description": "Username for administrative user"
            }
        },
        "adminPublicKey": {
            "type": "string",
            "metadata": {
                "description": "the public key starting with rsa"
            }
        },
        "virtualMachineSize": {
            "type": "string",
            "allowedValues": [
                "Basic_A0",
                "Basic_A1",
                "Basic_A2",
                "Basic_A3",
                "Basic_A4",
                "Standard_A0",
                "Standard_A1",
                "Standard_A2",
                "Standard_A3",
                "Standard_A5",
                "Standard_A4",
                "Standard_A6",
                "Standard_A7",
                "Standard_D1_v2",
                "Standard_D2_v2",
                "Standard_D3_v2",
                "Standard_D4_v2",
                "Standard_D5_v2",
                "Standard_D11_v2",
                "Standard_D12_v2",
                "Standard_D13_v2",
                "Standard_D14_v2",
                "Standard_D15_v2"
            ],
            "defaultValue": "Basic_A0",
            "metadata": {
                "description": "Virtual Machine SKU "
            }
        },
        "instanceCount": {
            "type": "string",
            "metadata": {
                "description": "Initial instant count for scale set"
            }
        },
        "osVersion": {
            "type": "string",
            "defaultValue": "7,2",
            "allowedValues": [
                "7.0",
                "7.1",
                "7.2"
            ],
            "metadata": {
                "description": "The  version for the VM. This will pick a fully patched image of this given OS version"
            }
        },
        "singlePlacementGroup": {
            "type": "string",
            "allowedValues": [
                "True",
                "False"
            ],
            "defaultValue": "True",
            "metadata": {
                "description": "Selct True if scale set will be less than 100 instances"
            }
        },
        "autoscaleDefault": {
            "type": "string",
            "defaultValue": "1",
            "metadata": {
                "description": "The number of nodes that will be scaled when scaling occurs"
            }
        },
        "autoscaleMax": {
            "type": "string",
            "metadata": {
                "description": "The maximum number of nodes allowed in the scale set"
            }
        },
        "autoscaleMin": {
            "type": "string",
            "metadata": {
                "description": "The minimum number of nodes allowed in the scale set"
            }
        },
        "scaleInCPUPercentageThreshold": {
            "type": "string",
            "defaultValue": "65",
            "metadata": {
                "description": "Scaling down will occur when CPU usage is below this threshold (1-100%) && RAM below threshold"
            }
        },
        "scaleOutCPUPercentageThreshold": {
            "type": "string",
            "defaultValue": "80",
            "metadata": {
                "description": "Scaling down will occur when CPU usage is above this threshold (1-100)"
            }
        },
        "scaleOutMemPercentageThreshold": {
           "type": "string",
           "defaultValue": "80",
           "metadata": {
                "description": "Scaling out will occur when Mem usage is above this threshold (1-100)"
            }
        },
        "scaleInMemPercentageThreshold": {
           "type": "string",
           "defaultValue": "65",
           "metadata": {
                "description": "Scaling down will occur when Mem usage is below this threshold (1-100%) && CPU below threshold"
            }
        },
        "scaleOutInterval": {
            "type": "string",
            "defaultValue": "10",
            "metadata": {
                "description": "how frequently in minutes should the scale set scale out"
            }
        },
        "scaleInInterval": {
            "type": "string",
            "defaultValue": "10",
            "metadata": {
                "description": "how frequently in minutes should the scale set scale in"
            }
        },
        "virtualNetworkName": {
            "type": "string",
            "defaultValue": "Netowrk",
            "allowedValues": [
                "Network"
            ],
            "metadata": {
                "description": "The name of the virtual network"
            }
        },
        "vmSubnetName": {
            "type": "string",
            "allowedValues": [
                "Outside",
                "DMZ",
                "Inside1",
                "Inside2",
                "Inside3"
            ],
            "metadata": {
                "description": "The name of the subnet that the scale set will be attached to"
            }
        },
        "diagStorageName": {
            "type": "string",
            "metadata": {
                "description": "The name of the diagnostic storage account"
            }
        }
    },
    "variables": {
        "locationShort": "[substring(parameters('location'),0,3)]",
        "ssName": "[concat(parameters('POC'), '-VMSS-', parameters('ssName'),'-', parameters('environment'), '-', variables('locationShort'))]",
        "namingInfix": "[toLower(substring(concat(parameters('ssName'), uniqueString(resourceGroup().id)), 0, 9))]",
        "loadBalancerName": "[concat(parameters('POC'), '-LB-', parameters('environment'), '-', variables('locationShort'))]",
        "networkInterfaceName": "[concat(parameters('POC'), '-NIC-', parameters('vmName'),'-', parameters('environment'), '-', variables('locationShort'))]",
        "vnetRg": "[concat('RG-',parameters('POC'),'-Network-',parameters('environment'),'-',variables('locationShort'))]",
        "vnetName": "[concat(parameters('POC'),'-VNET-',parameters('virtualNetworkName'),'-',parameters('environment'),'-',variables('locationShort'))]",
        "vmSubnetName": "[concat(parameters('POC'),'-VNET-Sub-',parameters('vmSubnetName'),'-',parameters('environment'),'-',variables('locationShort'))]",
        "diagStorageRgName": "[concat('RG-',parameters('POC'),'-DiagnosticStorage-',parameters('environment'),'-',variables('locationShort'))]",
        "diagStorageName": "[tolower(concat(parameters('POC'),parameters('diagStorageName'), parameters('environment'),uniqueString(subscription().id)))]",
        "diagnosticsStorageAccountId": "[concat(subscription().id,'/resourceGroups/',variables('diagStorageRgName'),'/providers/Microsoft.Storage/storageAccounts/',variables('diagStorageName'))]",
        "osType": {
            "publisher": "OpenLogic",
            "offer": "CentOS",
            "sku": "[parameters('osVersion')]",
            "version": "latest"
        },
        "imageReference": "[variables('osType')]"
    },
    "resources": [
        {
            "name": "[variables('ssName')]",
            "type": "Microsoft.Compute/virtualMachineScaleSets",
            "apiVersion": "2017-03-30",
            "location": "[parameters('location')]",
            "tags": {
                "Subscription": "[Subscription().displayName]",
                "POC": "[parameters('POC')]",
                "RG": "[resourceGroup().name]",
                "Environment": "[parameters('environment')]",
                "Owner": "[parameters('owner')]"
            },
            "dependsOn": [],
            "sku": {
                "name": "[parameters('virtualMachineSize')]",
                "tier": "Standard",
                "capacity": "[int(parameters('instanceCount'))]"
            },
            "properties": {
                "overprovision": "true",
                "upgradePolicy": {
                    "mode": "Manual"
                },
                "singlePlacementGroup": "[parameters('singlePlacementGroup')]",
                "virtualMachineProfile": {
                    "storageProfile": {
                        "imageReference": "[variables('imageReference')]",
                        "osDisk": {
                            "createOption": "FromImage",
                            "caching": "ReadWrite"
                        }
                    },
                    "osProfile": {
                        "computerNamePrefix": "[variables('namingInfix')]",
                        "adminUsername": "[parameters('adminUserName')]",
                        "linuxConfiguration": {
                            "disablePasswordAuthentication": "true",
                            "ssh": {
                                "publicKeys": [
                                    {
                                        "path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]",
                                        "keyData": "[parameters('adminPublicKey')]"
                                    }
                                ]
                            }
                        }
                    },
                    "networkProfile": {
                        "networkInterfaceConfigurations": [
                            {
                                "name": "[variables('networkInterfaceName')]",
                                "properties": {
                                    "primary": "true",
                                    "ipConfigurations": [
                                        {
                                            "name": "[concat(variables('ssName'), 'IpConfig')]",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', variables('vnetRg'), '/providers/Microsoft.Network/virtualNetworks/', variables('vnetName'), '/subnets/', variables('vmSubnetName'))]"
                                                },
                                                "loadBalancerBackendAddressPools": [
                                                    {
                                                        "id": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', variables('vnetRg'), '/providers/Microsoft.Network/loadBalancers/', variables('loadBalancerName'), '/backendAddressPools/bepool')]"
                                                    }
                                                ],
                                                "loadBalancerInboundNatPools": [
                                                    {
                                                        "id": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', variables('vnetRg'), '/providers/Microsoft.Network/loadBalancers/', variables('loadBalancerName'), '/inboundNatPools/natpool')]"
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    "extensionProfile": {
                        "extensions": [
                            {
                                "name": "LinuxDiagnosticExtension",
                                "properties": {
                                    "publisher": "Microsoft.Azure.Diagnostics",
                                    "type": "LinuxDiagnostic",
                                    "typeHandlerVersion": "3.0",
                                    "settings": {
                                        "StorageAccount": "[variables('diagStorageName')]",
                                        "ladCfg": {
                                            "diagnosticMonitorConfiguration": {
                                                "performanceCounters": {
                                                    "sinks": "WADMetricJsonBlob",
                                                    "performanceCounterConfiguration": [
                                                        {
                                                            "unit": "percent",
                                                            "type": "builtin",
                                                            "class": "memory",
                                                            "counter": "percentUsedMemory",
                                                            "counterSpecifier": "/builtin/memory/percentUsedMemory",
                                                            "condition": "IsAggregate=TRUE"
                                                        }
                                                    ]
                                                },
                                                "metrics": {
                                                    "metricAggregation": [
                                                        {
                                                            "scheduledTransferPeriod": "PT1M"
                                                        }
                                                    ],
                                                    "resourceId": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'myScaleSet')]"
                                                }
                                            }
                                        }
                                    },
                                    "protectedSettings": {
                                        "storageAccountName": "[variables('diagStorageName')]",
                                        "storageAccountKey": "[listKeys(variables('diagnosticsStorageAccountId'),'2015-06-15').key1]",
                                        "storageAccountEndPoint": "https://core.windows.net/",
                                        "sinksConfig": {
                                            "sink": [
                                                {
                                                    "name": "WADMetricJsonBlob",
                                                    "type": "JsonBlob"
                                                }
                                            ]
                                        }
                                    }
                                }
                            }
                        ]
                    }
                }
            }
        },
        {
            "type": "microsoft.insights/autoscalesettings",
            "name": "autoscaleSettings",
            "apiVersion": "2014-04-01",
            "location": "ukwest",
            "tags": {
                "Subscription": "[Subscription().displayName]",
                "POC": "[parameters('POC')]",
                "RG": "[resourceGroup().name]",
                "Environment": "[parameters('environment')]",
                "Owner": "[parameters('owner')]"
            },
            "scale": null,
            "properties": {
                "profiles": [
                    {
                        "name": "Auto created scale condition",
                        "capacity": {
                            "minimum": "[parameters('autoscaleMin')]",
                            "maximum": "[parameters('autoscaleMax')]",
                            "default": "[parameters('autoscaleDefault')]"
                        },
                        "rules": [
                            {
                                "metricTrigger": {
                                    "metricName": "/builtin/memory/percentUsedMemory",
                                    "metricNamespace": "",
                                    "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('ssName'))]",
                                    "timeGrain": "PT1M",
                                    "statistic": "Average",
                                    "timeWindow": "PT10M",
                                    "timeAggregation": "Average",
                                    "operator": "GreaterThan",
                                    "threshold": "[parameters('scaleOutMemPercentageThreshold')]"
                                },
                                "scaleAction": {
                                    "direction": "Increase",
                                    "type": "ChangeCount",
                                    "value": "1",
                                    "cooldown": "PT5M"
                                }
                            },
                            {
                                "metricTrigger": {
                                    "metricName": "Percentage CPU",
                                    "metricNamespace": "",
                                    "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets',  variables('ssName'))]",
                                    "timeGrain": "PT1M",
                                    "statistic": "Average",
                                    "timeWindow": "PT10M",
                                    "timeAggregation": "Average",
                                    "operator": "GreaterThan",
                                    "threshold": "[parameters('scaleOutCPUPercentageThreshold')]"
                                },
                                "scaleAction": {
                                    "direction": "Increase",
                                    "type": "ChangeCount",
                                    "value": "1",
                                    "cooldown": "PT5M"
                                }
                            },
                            {
                                "metricTrigger": {
                                    "metricName": "/builtin/memory/percentUsedMemory",
                                    "metricNamespace": "",
                                    "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets',  variables('ssName'))]",
                                    "timeGrain": "PT1M",
                                    "statistic": "Average",
                                    "timeWindow": "PT10M",
                                    "timeAggregation": "Average",
                                    "operator": "LessThan",
                                    "threshold": "[parameters('scaleInMemPercentageThreshold')]"
                                },
                                "scaleAction": {
                                    "direction": "Decrease",
                                    "type": "ChangeCount",
                                    "value": "1",
                                    "cooldown": "PT5M"
                                }
                            },
                            {
                                "metricTrigger": {
                                    "metricName": "Percentage CPU",
                                    "metricNamespace": "",
                                    "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets',  variables('ssName'))]",
                                    "timeGrain": "PT1M",
                                    "statistic": "Average",
                                    "timeWindow": "PT10M",
                                    "timeAggregation": "Average",
                                    "operator": "GreaterThan",
                                    "threshold": "[parameters('scaleInCPUPercentageThreshold')]"
                                },
                                "scaleAction": {
                                    "direction": "Decrease",
                                    "type": "ChangeCount",
                                    "value": "1",
                                    "cooldown": "PT5M"
                                }
                            }
                        ]
                    }
                ],
                "enabled": true,
                "name": "autoscaleSettings",
                "targetResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets',  variables('ssName'))]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachineScaleSets',  variables('ssName'))]"
            ]
        }
    ],
    "outputs": {}
}